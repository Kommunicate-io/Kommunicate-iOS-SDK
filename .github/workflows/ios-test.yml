name: iOS Automation Test Workflow

on:
  push:
    branches:
      - dev # Run the workflow on pushes to the dev branch
  pull_request:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Set up Xcode
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1.0' # Replace with the Xcode version you need

      # Step 3: Install dependencies (if using CocoaPods or Carthage)
      - name: Install Dependencies
        run: |
          pod install --project-directory=Example

      # Step 4: Inject Kommunicate APP_ID securely into an environment variable
      - name: Export Kommunicate APP_ID
        env:
          KOMMUNICATE_APP_ID: ${{ secrets.KOMMUNICATE_APP_ID }}
        run: |
          echo "KOMMUNICATE_APP_ID=$KOMMUNICATE_APP_ID" >> $GITHUB_ENV

      # Step 5: Run Tests
      - name: Run XCTest
        env:
          KOMMUNICATE_APP_ID: ${{ secrets.KOMMUNICATE_APP_ID }}
        run: |
          xcodebuild test \
            -workspace Example/Kommunicate.xcworkspace \
            -scheme Kommunicate_Example \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.1' \
            CODE_SIGNING_ALLOWED=NO \
            -enableCodeCoverage YES

      # Step 6 (Optional): Debug Environment Variables (Do not expose secrets in logs)
      - name: Debug Environment Variables
        run: |
          echo "Environment variables set successfully."
